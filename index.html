<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0084ff">
  <title>LocalChat</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.svg">
  
  <!-- Preconnect to CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Critical: LZString for data compression -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
</head>
<body>

  <!-- ==================== LOGIN SCREEN ==================== -->
  <div id="screen-login" class="screen active">
    <div class="center-box">
      <h1>LocalChat</h1>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">Peer-to-peer group chat</p>
      
      <div class="avatar avatar-lg" id="avatarPreview" onclick="document.getElementById('avatarInput').click()" style="cursor: pointer;"></div>
      <input type="file" id="avatarInput" accept="image/*" hidden onchange="handleAvatarInput(this)">
      
      <input type="text" id="username" placeholder="Choose a username" maxlength="30">
      <button class="btn btn-primary" onclick="saveProfile()">Get Started</button>
    </div>
  </div>

  <!-- ==================== LOBBY SCREEN ==================== -->
  <div id="screen-lobby" class="screen">
    <div class="center-box">
      <div class="avatar avatar-lg" id="lobbyAvatar" style="width: 60px; height: 60px; margin-bottom: 10px;"></div>
      <h2 id="lobby-welcome">Welcome</h2>
      <p style="color: var(--text-secondary); font-size: 0.9rem;">Start a group or join an existing one</p>
      
      <button class="btn btn-primary" style="width: 250px;" onclick="initHost()">
        Create Group
      </button>
      <button class="btn btn-outline" style="width: 250px;" onclick="initJoin()">
        Join Group
      </button>
      <button class="btn btn-outline" style="width: 250px; margin-top: 15px;" onclick="openHistory()">
        ðŸ“œ Chat History
      </button>
    </div>
  </div>

  <!-- ==================== CHAT SCREEN ==================== -->
  <div id="screen-chat" class="screen">
    <header>
      <div class="header-info">
        <div class="header-title" id="chat-title">Group Chat</div>
        <div class="header-status" id="status-indicator">
          <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
          Ready
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="btnAddMember" onclick="showInviteModal()" title="Add Member" style="display: none;">âž•</button>
        <button class="icon-btn" id="btnManageUsers" onclick="showParticipantsModal()" title="Participants" style="display: none;">ðŸ‘¥</button>
        <button class="icon-btn" onclick="confirmExit()" title="Leave" style="color: var(--danger);">ðŸšª</button>
      </div>
    </header>
    
    <div id="chat-view" class="chat-area"></div>
    
    <div class="input-area">
      <input type="text" id="msgInput" placeholder="Type a message..." maxlength="1000" autocomplete="off">
      <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- ==================== HISTORY SCREEN ==================== -->
  <div id="screen-history" class="screen">
    <header>
      <div class="header-title">Chat History</div>
      <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;" onclick="showScreen('lobby')">Back</button>
    </header>
    <div class="chat-area" style="background: var(--bg-primary);">
      <ul id="history-list" class="history-list"></ul>
    </div>
  </div>

  <!-- ==================== QR MODAL ==================== -->
  <div id="modal-qr" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="qr-title">Scan to Connect</h3>
        <button class="modal-close" onclick="closeModal('modal-qr')">Ã—</button>
      </div>
      
      <canvas id="qr-canvas"></canvas>
      
      <div class="qr-scanner">
        <video id="video-preview" class="qr-video" playsinline muted></video>
        <div id="qr-scanner-overlay" class="qr-overlay">
          <div class="qr-frame">
            <div class="qr-scanline"></div>
          </div>
        </div>
      </div>
      
      <div class="qr-status">
        <span class="qr-status-dot"></span>
        <span id="qr-status-text">Initializing...</span>
      </div>
      
      <button class="btn btn-outline" style="width: 100%;" onclick="closeModal('modal-qr')">Cancel</button>
      
      <button class="manual-toggle" onclick="toggleManualInput()">
        Or paste connection code manually
      </button>
      
      <div id="manual-input-container" class="manual-input">
        <textarea id="manual-code" rows="4" placeholder="Paste the connection code here..."></textarea>
        <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="handleManualCode()">Connect</button>
      </div>
      
      <!-- Zoom Controls -->
      <div id="zoom-controls" class="zoom-control">
        <div class="zoom-label">Zoom: <span id="zoom-value">1.0</span>x</div>
        <input type="range" id="zoom-slider" class="zoom-slider" min="1" max="3" step="0.1" value="1" oninput="qrScanner?.setZoom(this.value)">
        <div class="zoom-buttons">
          <button class="zoom-btn" onclick="qrScanner?.adjustZoom(-0.2)">âˆ’</button>
          <button class="zoom-btn" onclick="qrScanner?.adjustZoom(0.2)">+</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== PARTICIPANTS MODAL ==================== -->
  <div id="modal-users" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Participants</h3>
        <button class="modal-close" onclick="closeModal('modal-users')">Ã—</button>
      </div>
      <div id="participants-list" class="participants-list"></div>
      <button class="btn btn-outline" style="width: 100%;" onclick="closeModal('modal-users')">Close</button>
    </div>
  </div>

  <!-- ==================== EXTERNAL SCRIPTS ==================== -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <!-- ==================== APP SCRIPTS ==================== -->
  <script src="js/state.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/webrtc.js"></script>
  <script src="js/qrscanner.js"></script>
  <script src="js/app.js"></script>

</body>
</html>
