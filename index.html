<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalChat Group</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* --- SCREENS --- */
        .screen { display: none; padding: 20px; flex-direction: column; height: 100%; box-sizing: border-box; }
        .active { display: flex; }

        /* --- LOGIN SCREEN --- */
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: #ddd; margin: 0 auto 10px; background-size: cover; background-position: center; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input[type="text"] { padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px; text-align: center; }
        .btn-primary { background: #0084ff; color: white; }
        .btn-outline { background: white; border: 1px solid #0084ff; color: #0084ff; }

        /* --- CHAT SCREEN --- */
        header { background: white; padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; }
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .input-area { background: white; padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        
        /* Bubbles */
        .msg-row { display: flex; gap: 8px; align-items: flex-end; }
        .msg-row.me { flex-direction: row-reverse; }
        .msg-avatar { width: 30px; height: 30px; border-radius: 50%; background-size: cover; background-color: #eee; }
        .bubble { max-width: 70%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .me .bubble { background: #0084ff; color: white; border-bottom-right-radius: 4px; }
        .them .bubble { background: white; color: black; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sender-name { font-size: 0.75em; color: #777; margin-bottom: 2px; margin-left: 4px; }
        
        /* QR Modal */
        #qr-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; padding: 20px; color: white; }
        #qr-canvas { background: white; padding: 10px; border-radius: 8px; }
        #video-preview { width: 100%; max-width: 400px; border-radius: 8px; display: none; }
        
        /* Tabs */
        .tabs { display: flex; background: white; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #666; }
        .tab.active-tab { border-bottom: 2px solid #0084ff; color: #0084ff; font-weight: bold; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1 style="text-align: center;">LocalChat</h1>
        <div class="avatar-preview" id="avatarPreview"></div>
        <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatar(this)">
        <button class="btn btn-outline" onclick="document.getElementById('avatarInput').click()">Upload Photo</button>
        <input type="text" id="username" placeholder="Enter your name">
        <button class="btn btn-primary" onclick="saveProfile()">Start</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h1>Welcome, <span id="lobby-name"></span></h1>
        <button class="btn btn-primary" onclick="initHost()">Create Group (Host)</button>
        <button class="btn btn-outline" onclick="initJoin()">Join Group (Scan QR)</button>
    </div>

    <div id="screen-chat" class="screen">
        <header>
            <div id="header-title">Group Chat</div>
            <button class="btn btn-primary" style="width: auto; padding: 5px 10px; font-size: 0.8em;" onclick="showAddMemberModal()" id="addMemberBtn">Add Member</button>
        </header>
        
        <div class="tabs">
            <div class="tab active-tab" onclick="switchTab('chat')">Chat</div>
            <div class="tab" onclick="switchTab('notes')">ðŸ“Œ Notes</div>
        </div>

        <div id="view-chat" class="chat-area" style="display: flex;"></div>
        
        <div id="view-notes" class="chat-area" style="display: none;"></div>

        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Type a message...">
            <button class="btn btn-primary" style="width: auto; margin: 0;" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div id="qr-modal">
        <h2 id="modal-title">Scan to Connect</h2>
        <canvas id="qr-canvas"></canvas>
        <video id="video-preview" playsinline></video>
        <div id="modal-status" style="margin-top: 10px; text-align: center;"></div>
        <button class="btn btn-outline" style="margin-top: 20px; background: transparent; color: white; border-color: white;" onclick="closeModal()">Close</button>
    </div>

    <script>
        // --- STATE ---
        let me = { name: '', avatar: '', id: crypto.randomUUID() };
        let peers = {}; // Map of connectionId -> DataChannel (For Host)
        let serverConn = null; // DataChannel (For Guest)
        let isHost = false;
        let db;

        // --- 1. PROFILE LOGIC ---
        function handleAvatar(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                me.avatar = e.target.result; // Base64 string
                document.getElementById('avatarPreview').style.backgroundImage = `url(${me.avatar})`;
            };
            reader.readAsDataURL(file);
        }

        function saveProfile() {
            const name = document.getElementById('username').value;
            if(!name) return alert("Name required");
            me.name = name;
            // Set default avatar if none
            if(!me.avatar) me.avatar = `https://ui-avatars.com/api/?name=${name}&background=random`;
            
            document.getElementById('lobby-name').innerText = name;
            switchScreen('screen-lobby');
            initDB();
        }

        // --- 2. WEBRTC SIGNALING (QR) ---
        const rtcConfig = { iceServers: [] }; // Local only

        function initHost() {
            isHost = true;
            switchScreen('screen-chat');
            document.getElementById('header-title').innerText = "Hosting Group";
            addSystemMsg("You created the group. Click 'Add Member' to invite others.");
        }

        function initJoin() {
            isHost = false;
            document.getElementById('addMemberBtn').style.display = 'none'; // Guests can't invite yet
            startScanner();
        }

        // --- HOST: Generate Invite ---
        async function showAddMemberModal() {
            const pc = new RTCPeerConnection(rtcConfig);
            const channel = pc.createDataChannel("chat");
            
            // Generate Offer
            setupChannel(channel, pc); // Setup listeners
            
            const modal = document.getElementById('qr-modal');
            modal.style.display = 'flex';
            document.getElementById('qr-canvas').style.display = 'block';
            document.getElementById('video-preview').style.display = 'none';
            document.getElementById('modal-title').innerText = "Show this to Guest";
            document.getElementById('modal-status').innerText = "Generating Code...";

            pc.onicecandidate = (e) => {
                if (e.candidate === null) {
                    const data = JSON.stringify(pc.localDescription);
                    const compressed = LZString.compressToBase64(data);
                    QRCode.toCanvas(document.getElementById('qr-canvas'), compressed, { width: 250 });
                    document.getElementById('modal-status').innerText = "Scan this code, then I will scan you.";
                    
                    // After Guest scans us, they show us an Answer. We need to scan them.
                    const btn = document.createElement('button');
                    btn.className = "btn btn-primary";
                    btn.innerText = "Guest has scanned. Scan their Answer now.";
                    btn.style.marginTop = "15px";
                    btn.onclick = () => {
                        btn.remove();
                        startScanner(pc); // Host becomes scanner
                    };
                    document.getElementById('modal-status').appendChild(btn);
                }
            };
            
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
        }

        // --- SCANNER (Both Host & Guest use this) ---
        function startScanner(hostPC = null) {
            const modal = document.getElementById('qr-modal');
            modal.style.display = 'flex';
            document.getElementById('qr-canvas').style.display = 'none';
            const video = document.getElementById('video-preview');
            video.style.display = 'block';
            document.getElementById('modal-title').innerText = "Scanning...";
            document.getElementById('modal-status').innerText = "Point camera at QR code";

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
                video.srcObject = stream;
                video.play();
                requestAnimationFrame(() => tick(video, hostPC));
            });
        }

        function tick(video, hostPC) {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; 
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const imageData = canvas.getContext('2d').getImageData(0,0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    video.srcObject.getTracks().forEach(t => t.stop()); // Stop Camera
                    handleScan(code.data, hostPC);
                    return;
                }
            }
            requestAnimationFrame(() => tick(video, hostPC));
        }

        async function handleScan(data, hostPC) {
            const signal = JSON.parse(LZString.decompressFromBase64(data));

            if (isHost) {
                // Host scanned Guest's Answer
                await hostPC.setRemoteDescription(new RTCSessionDescription(signal));
                closeModal();
                addSystemMsg("New user connected!");
            } else {
                // Guest scanned Host's Offer
                const pc = new RTCPeerConnection(rtcConfig);
                pc.ondatachannel = (e) => setupChannel(e.channel, pc); // Guest receives channel
                
                await pc.setRemoteDescription(new RTCSessionDescription(signal));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                // Show Answer to Host
                const compressed = LZString.compressToBase64(JSON.stringify(pc.localDescription));
                document.getElementById('video-preview').style.display = 'none';
                document.getElementById('qr-canvas').style.display = 'block';
                QRCode.toCanvas(document.getElementById('qr-canvas'), compressed, { width: 250 });
                document.getElementById('modal-title').innerText = "Show this to Host";
                document.getElementById('modal-status').innerText = "Waiting for Host to confirm...";
                
                // When channel opens, this modal closes automatically via setupChannel
            }
        }

        // --- 3. CHANNEL LOGIC & ROUTING ---
        function setupChannel(channel, pc) {
            channel.onopen = () => {
                if (isHost) {
                    peers[channel.id] = channel; // Add to pool
                } else {
                    serverConn = channel;
                    switchScreen('screen-chat');
                    closeModal();
                }
                // Send Identity immediately
                const hello = { type: 'identity', user: me };
                channel.send(JSON.stringify(hello));
            };

            channel.onmessage = (e) => {
                const packet = JSON.parse(e.data);
                handlePacket(packet, channel);
            };
        }

        function handlePacket(packet, sourceChannel) {
            // 1. Identify Packet
            if (packet.type === 'identity') {
                addSystemMsg(`${packet.user.name} joined.`);
                // If Host, forward this identity to everyone else? (Optional for advanced polish)
                return;
            }

            // 2. Chat/Note Packet
            // If I am Host, I must Forward it to everyone else
            if (isHost) {
                Object.values(peers).forEach(p => {
                    if (p.id !== sourceChannel.id && p.readyState === 'open') {
                        p.send(JSON.stringify(packet));
                    }
                });
            }

            // 3. Render it
            if (packet.type === 'chat') renderMessage(packet.user, packet.text, false);
            if (packet.type === 'note') renderNote(packet.user, packet.text);
        }

        // --- 4. UI & SENDING ---
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value;
            if (!text) return;

            // Check if user wants to make this a "Note" (e.g., starts with /note)
            const type = document.querySelector('.active-tab').innerText.includes("Notes") ? 'note' : 'chat';
            
            const packet = { type: type, text: text, user: me, id: crypto.randomUUID() };

            // Render Locally
            if (type === 'chat') renderMessage(me, text, true);
            if (type === 'note') renderNote(me, text);

            // Send Network
            const payload = JSON.stringify(packet);
            if (isHost) {
                Object.values(peers).forEach(p => p.send(payload));
            } else if (serverConn) {
                serverConn.send(payload);
            }

            input.value = "";
            
            // Save to DB
            saveToDB(packet);
        }

        function renderMessage(user, text, isMe) {
            const container = document.getElementById('view-chat');
            const row = document.createElement('div');
            row.className = `msg-row ${isMe ? 'me' : 'them'}`;
            
            row.innerHTML = `
                ${!isMe ? `<div class="msg-avatar" style="background-image: url('${user.avatar}')"></div>` : ''}
                <div>
                    ${!isMe ? `<div class="sender-name">${user.name}</div>` : ''}
                    <div class="bubble">${text}</div>
                </div>
            `;
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }

        function renderNote(user, text) {
            const container = document.getElementById('view-notes');
            const card = document.createElement('div');
            card.style.background = "#fff";
            card.style.padding = "10px";
            card.style.borderRadius = "8px";
            card.style.border = "1px solid #ddd";
            card.innerHTML = `<strong>${user.name}</strong><br>${text}`;
            container.appendChild(card);
            
            // Alert in chat too
            addSystemMsg(`${user.name} posted a new Note.`);
        }

        function addSystemMsg(text) {
            const container = document.getElementById('view-chat');
            const div = document.createElement('div');
            div.style.textAlign = "center";
            div.style.fontSize = "0.8em";
            div.style.color = "#999";
            div.style.margin = "10px 0";
            div.innerText = text;
            container.appendChild(div);
        }

        // --- UTILS ---
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
            event.target.classList.add('active-tab');
            document.getElementById('view-chat').style.display = tab === 'chat' ? 'flex' : 'none';
            document.getElementById('view-notes').style.display = tab === 'notes' ? 'flex' : 'none';
        }

        function closeModal() {
            document.getElementById('qr-modal').style.display = 'none';
            // Stop any active video streams
            const v = document.getElementById('video-preview');
            if(v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
        }
        
        // --- DATABASE ---
        function initDB() {
            const req = indexedDB.open("GroupChatDB", 1);
            req.onupgradeneeded = e => {
                e.target.result.createObjectStore("history", { keyPath: "id" });
            };
            req.onsuccess = e => {
                db = e.target.result;
                // Load history
                db.transaction("history").objectStore("history").getAll().onsuccess = (ev) => {
                    ev.target.result.forEach(p => {
                        if(p.type === 'chat') renderMessage(p.user, p.text, p.user.id === me.id);
                        if(p.type === 'note') renderNote(p.user, p.text);
                    });
                };
            };
        }

        function saveToDB(packet) {
            if(db) db.transaction("history", "readwrite").objectStore("history").add(packet);
        }

    </script>
</body>
</html>
